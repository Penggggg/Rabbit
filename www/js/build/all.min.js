var app=angular.module("rabbitApp",["ionic","btford.socket-io","ngCordova","appController","appDirective","appFilter","appServer","ngAnimate","ngResource"]);app.config(["$ionicConfigProvider","$stateProvider","$urlRouterProvider","$httpProvider",function(e,t,o,r){e.tabs.style("striped"),e.tabs.position("top "),e.form.checkbox("circle"),e.form.toggle("large"),o.otherwise("/tabs/funs"),t.state("tabs",{url:"/tabs",views:{middle:{templateUrl:function(){return"template/tabs.html"}}}}).state("tabs.funs",{url:"/funs",views:{fun:{templateUrl:function(){return"template/tabFuns.html"}}}}).state("tabs.chats",{url:"/chats",views:{chats:{templateUrl:function(){return"template/tabChats.html"}}}}).state("tabs.find",{url:"/find",views:{find:{templateUrl:function(){return"template/tabFind.html"}}}}).state("tabs.detail",{url:"/detail",views:{chats:{templateUrl:function(){return"template/ChatDetail.html"}}}}).state("tabs.chattogether",{url:"/chattogether",views:{chats:{templateUrl:function(){return"template/ChatTOgether.html"}}}}).state("register",{url:"/register",views:{middle:{templateUrl:function(){return"template/registerModel.html"}}}}).state("logIn",{url:"/logIn",views:{middle:{templateUrl:function(){return"template/logInModel.html"}}}}),r.defaults.useXDomain=!0,delete r.defaults.headers.common["X-Requested-With"]}]),app.run(["$ionicPlatform","$ionicPopup","$ionicHistory","$location","$cordovaKeyboard","msgStorage","loginSocket","Chat","eventEmmiter","$q","$timeout","$rootScope","pubicChatStore",function(e,t,o,r,n,a,i,c,s,l,u,p,d){e.ready(function(){window.cordova&&window.cordova.plugins.Keyboard&&(cordova.plugins.Keyboard.hideKeyboardAccessoryBar(!0),cordova.plugins.Keyboard.disableScroll(!0)),window.StatusBar&&StatusBar.styleDefault(),e.registerBackButtonAction(function(e){function a(){var e=t.confirm({title:"<strong>退出应用?</strong>",template:"你确定要退出应用吗?",okText:"退出",cancelText:"取消"});e.then(function(e){e&&ionic.Platform.exitApp()})}e.preventDefault(),"/tabs/funs"==r.path()?a():n.isVisible()?n.close():o.backView()?o.goBack():a()},101)}),c.socketInstance.on("publicMsg",function(e){console.log("全局环境app接受到信息："+e),d.initStore.push(d.decorateData(e))})}]);var appController=angular.module("appController",[]);appController.controller("rooCtrl",["$scope",function(e){e.rootObj={}}]),appController.controller("headPopoverCtrl",["$scope","$ionicPopover","$ionicModal","$timeout","eventEmmiter",function(e,t,o,r,n){e.popover=t.fromTemplateUrl("template/popover.html",{scope:e}),t.fromTemplateUrl("template/popover.html",{scope:e}).then(function(t){e.popover=t}),e.openPopover=function(t){e.popover.show(t)},e.closePopover=function(){e.popover.hide()},e.enterReg=function(){n.toBroadcast("enterReg")},e.enterLog=function(){n.toBroadcast("enterLog")}}]),appController.controller("registerCtrl",["$scope","$resource","$ionicLoading","eventEmmiter","$timeout","$location",function(e,t,o,r,n,a){e.reg={};var i=e.reg;i.PSWAtext="Password Again",i.userText="UserName",i.registe=function(){o.show({template:'<ion-spinner icon="ios"></ion-spinner>',content:"Loading",animation:"fade-in",showBackdrop:!0,maxWidth:200,showDelay:0});var e=t("http://www.hirabbit.cn/RabbitSoftware/users");e.save({},{name:i.name,password:i.PSW},function(e){"Registed!"==e.statusText?n(function(){o.hide(),n(function(){a.path("/logIn")},100)},800):"user has already existed"==e.statusText?(console.log("用户已存在"),o.hide(),r.toBroadcast("UserExisted")):r.toBroadcast("ServerDown")},function(e){o.hide(),r.toBroadcast("NetworkBreak")})},e.$on("enterReg",function(){i.name="",i.PSW="",i.PSWA=""})}]),appController.controller("logInCtrl",["$scope","$resource","$http","eventEmmiter","$ionicLoading","$timeout","$location","msgStorage","loginSocket",function(e,t,o,r,n,a,i,c,s){e.log={};var l=e.log;l.userText="UserName",l.pswText="Password",l.logIn=function(){n.show({template:'<ion-spinner icon="ios"></ion-spinner>',content:"Loading",animation:"fade-in",showBackdrop:!0,maxWidth:200,showDelay:0});var e=t("http://www.hirabbit.cn/RabbitSoftware/login",{name:"@name",password:"@password"},{save:{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded; charset=UTF-8"}}});e.save({},{name:l.name,password:l.PSW},function(e){var t=e.statusText,o=e.user;"user not existed"==t?r.toBroadcast("UserNotExisted"):"password not matched"==t?r.toBroadcast("pswNotMatch"):"login"==t?(console.log("密码验证成功"),r.toBroadcast("login"),c.setUserStorage(o),s.login({user:c.getUserStorage().account}),a(function(){n.hide(),a(function(){i.path("/tabs/chats")},100)},800)):r.toBroadcast("ServerDown2")},function(e){console.log(e),r.toBroadcast("NetworkBreak2"),n.hide()})},e.$on("enterLog",function(){l.test=mySocket.isConnected(),l.name="",l.PSW=""})}]),appController.controller("findCtrl",["$scope","$resource",function(e,t){e.find={},_scopeFind=e.find,_scopeFind.test=function(){}}]),appController.controller("chatDetailCtrl",["$scope","Chat","msgStorage",function(e,t,o){e.chat={};var r=e.chat;r.sendMsg=function(){t.sendMsg({from:o.getUserStorage().account,text:r.text})},e.$on("getPublicMsg",function(e,t){console.log("Controller 接到"+t.text)})}]),appController.controller("chatTogetherCtrl",["$scope","Chat","msgStorage","$rootScope","pubicChatStore","$ionicScrollDelegate",function(e,t,o,r,n,a){e.chat={};var i=e.chat;i.scroll=!0,i.bouncing=!0,i.overFlow=!0,i.chatData=n.initStore,i.sendMsg=function(){t.sendMsg({from:o.getUserStorage().account,text:i.text}),i.chatData.push({type:"msg",left:!1,right:!0,from:"Me",text:i.text}),a.scrollBottom(!0),i.text=""},e.$watchCollection("chat.chatData",function(e){console.log("in"),a.scrollBottom(!0)})}]),appController.controller("tabsChatCtrl",["$scope","$location","eventEmmiter",function(e,t,o){e.tab={},_scopeTab=e.tab}]),appController.controller("tabFunCtrl",["$scope","msgStorage","loginSocket",function(e,t,o){e.fun={},_scopeFun=e.fun,_scopeFun.initFun=function(){console.log("in"),t.getUserStorage()&&o.login({user:t.getUserStorage().account})}}]);var appDirective=angular.module("appDirective",[]);appDirective.directive("checkPasswordRepeat",function(){return{restrict:"AE",require:"ngModel",link:function(e,t,o,r){var n=e.reg;e.$watch("reg.PSWA",function(e){e==n.PSW?(r.$setValidity("checkPasswordRepeat",!0),n.PSWAtext="Password Again"):(r.$setValidity("checkPasswordRepeat",!1),n.PSWAtext="Password not match")}),e.$watch("reg.PSW",function(e){e==n.PSWA?(r.$setValidity("checkPasswordRepeat",!0),n.PSWAtext="Password Again"):(r.$setValidity("checkPasswordRepeat",!1),n.PSWAtext="Password not match")})}}}),appDirective.directive("checkNameRepeat",["$resource",function(e){return{restrict:"AE",require:"ngModel",link:function(t,o,r,n){var a=t.reg;t.$watch("reg.name",function(t){if(a.name){var o=e("http://www.hirabbit.cn/RabbitSoftware/users/:username",{username:"@username"});o.get({username:a.name},function(e){e.statusText?(n.$setValidity("checkNameRepeat",!1),a.userText="User has been exist"):(n.$setValidity("checkNameRepeat",!0),a.userText="UserName")},function(e){console.log(e),n.$setValidity("checkNameRepeat",!1),a.userText="NetWork Break.."})}}),t.$on("UserExisted",function(){n.$setValidity("checkNameRepeat",!1),a.userText="User has been exist"}),t.$on("NetworkBreak",function(){n.$setValidity("checkNameRepeat",!1),a.userText="Please check your netWork"}),t.$on("ServerDown",function(){n.$setValidity("checkNameRepeat",!1),a.userText="Server has something wrong.."})}}}]),appDirective.directive("checkNameRepeat2",["$resource","$ionicLoading",function(e,t){return{restrict:"AE",require:"ngModel",link:function(o,r,n,a){var i=o.log;o.$watch("log.name",function(t){if(t){var o=e("http://www.hirabbit.cn/RabbitSoftware/users/:username",{username:"@username"});o.get({username:i.name},function(e){e.statusText?(a.$setValidity("checkNameRepeat2",!0),i.userText="UserName"):(a.$setValidity("checkNameRepeat2",!1),i.userText="User is not exist")},function(e){console.log(e),a.$setValidity("checkNameRepeat2",!1),i.userText="NetWork Break.."})}}),o.$on("UserNotExisted",function(){a.$setValidity("checkNameRepeat2",!1),i.userText="User is not exist",t.hide()}),o.$on("NetworkBreak2",function(){a.$setValidity("checkNameRepeat2",!1),i.userText="Please check your netWork",t.hide()}),o.$on("ServerDown2",function(){a.$setValidity("checkNameRepeat2",!1),i.userText="Server has something wrong..",t.hide()})}}}]),appDirective.directive("pswMatch",["$resource","$ionicLoading",function(e,t){return{restrict:"AE",require:"ngModel",link:function(e,o,r,n){var a=e.log;e.$watch("log.PSW",function(e){n.$setValidity("pswMatch",!0),a.pswText="Password"}),e.$on("pswNotMatch",function(){n.$setValidity("pswMatch",!1),a.pswText="passwork not match",t.hide()})}}}]);var appFilter=angular.module("appFilter",[]),appServer=angular.module("appServer",[]);appServer.factory("eventEmmiter",["$rootScope","$timeout",function(e,t){var o=function(o,r){t(function(){console.log("$rootScope发射事件中 事件数据为："+r),e.$broadcast(o,r)},100)};return{toBroadcast:function(e,t){return o(e,t)}}}]),appServer.factory("msgStorage",["$window",function(e){var t=function(){return"undefined"==e.localStorage?"false":"true"},o=function(){return e.localStorage.user?"true":"false"},r=function(t){e.localStorage.user=JSON.stringify(t),console.log("保存到本地")},n=function(){return console.log("清空user"),e.localStorage.removeItem("user")},a=function(){return JSON.parse(e.localStorage.user)};return{isSupportLocalStorage:function(){return t()},hasUserStorage:function(){return o()},setUserStorage:function(e){return r(e)},clearUserStorage:function(){return n()},getUserStorage:function(){return a()}}}]),appServer.factory("Socket",["socketFactory",function(e){var t=io.connect("http://www.hirabbit.cn:80");return mySocket=e({ioSocket:t}),mySocket}]),appServer.factory("loginSocket",["Socket",function(e){var t=function(t){console.log("用户登录中..."),e.emit("login",t)};return{login:function(e){return t(e)}}}]),appServer.factory("Chat",["Socket",function(e){var t=function(t){e.emit("publicMsg",t)};return{sendMsg:function(e){return t(e)},socketInstance:e}}]),appServer.factory("pubicChatStore",["$rootScope",function(e){var t=[{type:"msg",left:!0,right:!1,from:"HeZhuoPeng",text:"hello, man. Im a shuaige."},{type:"msg",left:!1,right:!0,from:"Me",text:"Back off, man. Im shuaige to."},{type:"sys",left:!0,right:!1,from:"",text:"somebody join!"}],o=function(e){return e.type="msg",e.left=!0,e.right=!1,e};return{initStore:t,decorateData:function(e){return o(e)}}}]);