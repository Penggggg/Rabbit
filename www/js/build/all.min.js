var app=angular.module("rabbitApp",["ionic","btford.socket-io","ngCordova","appController","appDirective","appFilter","appServer","ngAnimate","ngResource"]);app.config(["$ionicConfigProvider","$stateProvider","$urlRouterProvider","$httpProvider",function(e,t,o,a){e.tabs.style("striped"),e.tabs.position("top "),e.form.checkbox("circle"),e.form.toggle("large"),o.otherwise("/tabs/funs"),t.state("tabs",{url:"/tabs",views:{middle:{templateUrl:function(){return"template/tabs.html"}}}}).state("tabs.funs",{url:"/funs",views:{fun:{templateUrl:function(){return"template/tabFuns.html"}}}}).state("tabs.chats",{url:"/chats",views:{chats:{templateUrl:function(){return"template/tabChats.html"}}}}).state("tabs.find",{url:"/find",views:{find:{templateUrl:function(){return"template/tabFind.html"}}}}).state("tabs.detail",{url:"/detail",views:{chats:{templateUrl:function(){return"template/ChatDetail.html"}}}}).state("tabs.chattogether",{url:"/chattogether",views:{chats:{templateUrl:function(){return"template/ChatTOgether.html"}}}}).state("register",{url:"/register",views:{middle:{templateUrl:function(){return"template/registerModel.html"}}}}).state("logIn",{url:"/logIn",views:{middle:{templateUrl:function(){return"template/logInModel.html"}}}}),a.defaults.useXDomain=!0,delete a.defaults.headers.common["X-Requested-With"]}]),app.run(["$ionicPlatform","$ionicPopup","$ionicHistory","$location","$cordovaKeyboard","msgStorage","loginSocket","Chat","eventEmmiter","$q","$timeout","$rootScope",function(e,t,o,a,r,n,i,c,s,l,u,p){e.ready(function(){window.cordova&&window.cordova.plugins.Keyboard&&(cordova.plugins.Keyboard.hideKeyboardAccessoryBar(!0),cordova.plugins.Keyboard.disableScroll(!0)),window.StatusBar&&StatusBar.styleDefault(),e.registerBackButtonAction(function(e){function n(){var e=t.confirm({title:"<strong>退出应用?</strong>",template:"你确定要退出应用吗?",okText:"退出",cancelText:"取消"});e.then(function(e){e&&ionic.Platform.exitApp()})}e.preventDefault(),"/tabs/funs"==a.path()?n():r.isVisible()?r.close():o.backView()?o.goBack():n()},101)});var g=l.defer(),h=g.promise;p.chatCache=new Array,p.chatCache.publicMsgCache=[],p.chatData={},p.chatData.pubicMsgData=[{type:"msg",left:!0,right:!1,from:"HeZhuoPeng",text:"hello, man. Im a shuaige."},{type:"msg",left:!1,right:!0,from:"Me",text:"Back off, man. Im shuaige to.kjsd kajsd ksd kasnd aksdj askdjas kj"},{type:"sys",left:!0,right:!1,from:"",text:"somebody join!"}],n.getUserStorage()&&i.login({user:n.getUserStorage().account}),c.socketInstance.on("publicMsg",function(e){console.log("全局环境app接受到信息："+e),console.log("缓存新消息至缓存队列"),p.chatCache.publicMsgCache.push(e),s.toBroadcast("getPublicMsg",e),u(function(){g.resolve()},101)}),h.then(function(){p.$on("CtrlGetMsg",function(){console.log("Ctrl接受到信息"),p.chatCache.publicMsgCache=[],console.log("消息缓存队列清空.")})},function(){console.log("defer failed")}),p.$on("initChatData",function(){s.toBroadcast("ChatData",p.chatCache.publicMsgCache),console.log("正在读取消息缓存"),p.chatCache.publicMsgCache=[],console.log("消息队列清空.")})}]);var appController=angular.module("appController",[]);appController.controller("rooCtrl",["$scope",function(e){e.rootObj={}}]),appController.controller("headPopoverCtrl",["$scope","$ionicPopover","$ionicModal","$timeout","eventEmmiter",function(e,t,o,a,r){e.popover=t.fromTemplateUrl("template/popover.html",{scope:e}),t.fromTemplateUrl("template/popover.html",{scope:e}).then(function(t){e.popover=t}),e.openPopover=function(t){e.popover.show(t)},e.closePopover=function(){e.popover.hide()},e.enterReg=function(){r.toBroadcast("enterReg")},e.enterLog=function(){r.toBroadcast("enterLog")}}]),appController.controller("registerCtrl",["$scope","$resource","$ionicLoading","eventEmmiter","$timeout","$location",function(e,t,o,a,r,n){e.reg={};var i=e.reg;i.PSWAtext="Password Again",i.userText="UserName",i.registe=function(){o.show({template:'<ion-spinner icon="ios"></ion-spinner>',content:"Loading",animation:"fade-in",showBackdrop:!0,maxWidth:200,showDelay:0});var e=t("http://www.hirabbit.cn/RabbitSoftware/users");e.save({},{name:i.name,password:i.PSW},function(e){"Registed!"==e.statusText?r(function(){o.hide(),r(function(){n.path("/logIn")},100)},800):"user has already existed"==e.statusText?(console.log("用户已存在"),o.hide(),a.toBroadcast("UserExisted")):a.toBroadcast("ServerDown")},function(e){o.hide(),a.toBroadcast("NetworkBreak")})},e.$on("enterReg",function(){i.name="",i.PSW="",i.PSWA=""})}]),appController.controller("logInCtrl",["$scope","$resource","$http","eventEmmiter","$ionicLoading","$timeout","$location","msgStorage","loginSocket",function(e,t,o,a,r,n,i,c,s){e.log={};var l=e.log;l.userText="UserName",l.pswText="Password",l.logIn=function(){r.show({template:'<ion-spinner icon="ios"></ion-spinner>',content:"Loading",animation:"fade-in",showBackdrop:!0,maxWidth:200,showDelay:0});var e=t("http://www.hirabbit.cn/RabbitSoftware/login",{name:"@name",password:"@password"},{save:{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded; charset=UTF-8"}}});e.save({},{name:l.name,password:l.PSW},function(e){var t=e.statusText,o=e.user;"user not existed"==t?a.toBroadcast("UserNotExisted"):"password not matched"==t?a.toBroadcast("pswNotMatch"):"login"==t?(console.log("密码验证成功"),a.toBroadcast("login"),c.setUserStorage(o),s.login({user:c.getUserStorage().account}),n(function(){r.hide(),n(function(){i.path("/tabs/chats")},100)},800)):a.toBroadcast("ServerDown2")},function(e){console.log(e),a.toBroadcast("NetworkBreak2"),r.hide()})},e.$on("enterLog",function(){l.test=mySocket.isConnected(),l.name="",l.PSW=""})}]),appController.controller("findCtrl",["$scope","$resource",function(e,t){e.find={},_scopeFind=e.find,_scopeFind.test=function(){}}]),appController.controller("chatDetailCtrl",["$scope","Chat","msgStorage",function(e,t,o){e.chat={};var a=e.chat;a.sendMsg=function(){t.sendMsg({from:o.getUserStorage().account,text:a.text})},e.$on("getPublicMsg",function(e,t){console.log("Controller 接到"+t.text)})}]),appController.controller("chatTogetherCtrl",["$scope","Chat","msgStorage","$rootScope",function(e,t,o,a){e.chat={};var r=e.chat;r.chatData=a.chatData.pubicMsgData,r.sendMsg=function(){t.sendMsg({from:o.getUserStorage().account,text:r.text}),a.chatData.pubicMsgData.push({type:"msg",left:!1,right:!0,from:"Me",text:r.text}),r.text=""},e.$on("getPublicMsg",function(t,o){console.log("Controller 接到"+o.text),r.decorateData(o),e.$emit("CtrlGetMsg")}),r.decorateData=function(e){e.type="msg",e.left=!0,e.right=!1,a.chatData.pubicMsgData.push(e)},e.$on("enterChatTogether",function(){console.log("initChatData..."),e.$emit("initChatData")}),e.$on("ChatData",function(e,t){t&&(console.log("Ctrl接受到消息缓存"+t),angular.forEach(t,function(e){r.decorateData(e)}))})}]),appController.controller("tabsChatCtrl",["$scope","$location","eventEmmiter",function(e,t,o){e.tab={},_scopeTab=e.tab,_scopeTab.initChatData=function(){o.toBroadcast("enterChatTogether")}}]);var appDirective=angular.module("appDirective",[]);appDirective.directive("checkPasswordRepeat",function(){return{restrict:"AE",require:"ngModel",link:function(e,t,o,a){var r=e.reg;e.$watch("reg.PSWA",function(e){e==r.PSW?(a.$setValidity("checkPasswordRepeat",!0),r.PSWAtext="Password Again"):(a.$setValidity("checkPasswordRepeat",!1),r.PSWAtext="Password not match")}),e.$watch("reg.PSW",function(e){e==r.PSWA?(a.$setValidity("checkPasswordRepeat",!0),r.PSWAtext="Password Again"):(a.$setValidity("checkPasswordRepeat",!1),r.PSWAtext="Password not match")})}}}),appDirective.directive("checkNameRepeat",["$resource",function(e){return{restrict:"AE",require:"ngModel",link:function(t,o,a,r){var n=t.reg;t.$watch("reg.name",function(t){if(n.name){var o=e("http://www.hirabbit.cn/RabbitSoftware/users/:username",{username:"@username"});o.get({username:n.name},function(e){e.statusText?(r.$setValidity("checkNameRepeat",!1),n.userText="User has been exist"):(r.$setValidity("checkNameRepeat",!0),n.userText="UserName")},function(e){console.log(e),r.$setValidity("checkNameRepeat",!1),n.userText="NetWork Break.."})}}),t.$on("UserExisted",function(){r.$setValidity("checkNameRepeat",!1),n.userText="User has been exist"}),t.$on("NetworkBreak",function(){r.$setValidity("checkNameRepeat",!1),n.userText="Please check your netWork"}),t.$on("ServerDown",function(){r.$setValidity("checkNameRepeat",!1),n.userText="Server has something wrong.."})}}}]),appDirective.directive("checkNameRepeat2",["$resource","$ionicLoading",function(e,t){return{restrict:"AE",require:"ngModel",link:function(o,a,r,n){var i=o.log;o.$watch("log.name",function(t){if(t){var o=e("http://www.hirabbit.cn/RabbitSoftware/users/:username",{username:"@username"});o.get({username:i.name},function(e){e.statusText?(n.$setValidity("checkNameRepeat2",!0),i.userText="UserName"):(n.$setValidity("checkNameRepeat2",!1),i.userText="User is not exist")},function(e){console.log(e),n.$setValidity("checkNameRepeat2",!1),i.userText="NetWork Break.."})}}),o.$on("UserNotExisted",function(){n.$setValidity("checkNameRepeat2",!1),i.userText="User is not exist",t.hide()}),o.$on("NetworkBreak2",function(){n.$setValidity("checkNameRepeat2",!1),i.userText="Please check your netWork",t.hide()}),o.$on("ServerDown2",function(){n.$setValidity("checkNameRepeat2",!1),i.userText="Server has something wrong..",t.hide()})}}}]),appDirective.directive("pswMatch",["$resource","$ionicLoading",function(e,t){return{restrict:"AE",require:"ngModel",link:function(e,o,a,r){var n=e.log;e.$watch("log.PSW",function(e){r.$setValidity("pswMatch",!0),n.pswText="Password"}),e.$on("pswNotMatch",function(){r.$setValidity("pswMatch",!1),n.pswText="passwork not match",t.hide()})}}}]);var appFilter=angular.module("appFilter",[]),appServer=angular.module("appServer",[]);appServer.factory("eventEmmiter",["$rootScope","$timeout",function(e,t){var o=function(o,a){t(function(){console.log("$rootScope发射事件中 事件数据为："+a),e.$broadcast(o,a)},100)};return{toBroadcast:function(e,t){return o(e,t)}}}]),appServer.factory("msgStorage",["$window",function(e){var t=function(){return"undefined"==e.localStorage?"false":"true"},o=function(){return e.localStorage.user?"true":"false"},a=function(t){e.localStorage.user=JSON.stringify(t),console.log("保存到本地")},r=function(){return console.log("清空user"),e.localStorage.removeItem("user")},n=function(){return JSON.parse(e.localStorage.user)};return{isSupportLocalStorage:function(){return t()},hasUserStorage:function(){return o()},setUserStorage:function(e){return a(e)},clearUserStorage:function(){return r()},getUserStorage:function(){return n()}}}]),appServer.factory("Socket",["socketFactory",function(e){var t=io.connect("http://www.hirabbit.cn:80");return mySocket=e({ioSocket:t}),mySocket}]),appServer.factory("loginSocket",["Socket",function(e){var t=function(t){console.log("用户登录中..."),e.emit("login",t)};return{login:function(e){return t(e)}}}]),appServer.factory("Chat",["Socket",function(e){var t=function(t){e.emit("publicMsg",t)};return{sendMsg:function(e){return t(e)},socketInstance:e}}]);